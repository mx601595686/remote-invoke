"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const log_formatter_1 = require("log-formatter");
const MessageType_1 = require("./common/MessageType");
const SendingManager_1 = require("./SendingManager");
/**
 *  远程调用控制器
 *
 * @export
 * @class RemoteInvoke
 */
class RemoteInvoke extends SendingManager_1.SendingManager {
    constructor(config) {
        super(config);
        this._invokeCallback = new Map(); // 注册调用回调
        /**
         * 对外导出的方法列表
         */
        this.exportList = new Map();
        /**
         * 注册的广播接收器
         *
         * key：moduleName -> messageName
         */
        this.receiveList = new Map();
        this.moduleName = config.moduleName;
        this._reportErrorStack = !!config.reportErrorStack;
        this._timeout = config.timeout === undefined ? 0 : config.timeout < 0 ? 0 : config.timeout;
        this._invokeFailedRetry = config.invokeFailedRetry === undefined ? 0 : config.invokeFailedRetry < 0 ? 0 : config.invokeFailedRetry;
    }
    /**
     * 发送消息
     *
     * @private
     * @param {(string | undefined)} receiver 接收模块的名称
     * @param {string} messageName 消息的名称
     * @param {string} messageID 消息的编号
     * @param {MessageType} type 消息的类型
     * @param {(number | undefined)} expire 过期时间
     * @param {any} data 要发送的数据
     * @param {Error} [error] 要反馈给调用则的错误信息
     * @returns {Promise<void>}
     * @memberof RemoteInvoke
     */
    _send(receiver, messageName, messageID, type, expire, data, error) {
        const sendingData = {
            sender: this.moduleName,
            receiver,
            messageID,
            messageName,
            type,
            sendTime: (new Date).getTime(),
            expire,
            data,
            error: error === undefined ? undefined : { message: error.message, stack: this._reportErrorStack ? error.stack : undefined }
        };
        return super._sendData(sendingData);
    }
    /**
     * 接收消息
     *
     * @protected
     * @param {SendingData} data 收到的数据
     * @memberof RemoteInvoke
     */
    _onMessage(data) {
        switch (data.type) {
            case MessageType_1.MessageType.invoke:
                if (data.receiver !== this.moduleName) {
                    this._errorLog('收到了不属于自己的消息', data);
                }
                else if (data.expire === 0 || data.expire > (new Date).getTime()) {
                    const func = this.exportList.get(data.messageName);
                    const send = this._send.bind(this, data.sender, undefined, data.messageID, MessageType_1.MessageType.replyInvoke, data.expire);
                    if (func !== undefined) {
                        func(data.data)
                            .then((result) => [result])
                            .catch((err) => [undefined, err])
                            .then(result => {
                            if (data.expire === 0 || data.expire > (new Date).getTime())
                                send(...result).catch(() => { });
                        });
                    }
                    else {
                        send(undefined, new Error('调用远端模块的方法不存在或者没有被导出')).catch(() => { });
                    }
                }
                break;
            case MessageType_1.MessageType.replyInvoke:
                if (data.receiver !== this.moduleName) {
                    this._errorLog('收到了不属于自己的消息', data);
                }
                else {
                    const ctrl = this._invokeCallback.get(data.messageID);
                    if (ctrl !== undefined) {
                        if (ctrl.targetName !== data.sender) {
                            ctrl.reject(new Error(`远端调用返回的结果并不是由期望的被调用者返回的！\r\n期望的被调用者：${ctrl.targetName}   实际返回结果的被调用者：${data.sender}`));
                        }
                        else {
                            if (data.error == null)
                                ctrl.resolve(data.data);
                            else {
                                const err = new Error(data.error.message);
                                if (data.error.stack != null)
                                    err.stack = data.error.stack;
                                ctrl.reject(err);
                            }
                        }
                    }
                }
                break;
            case MessageType_1.MessageType.broadcast:
                if (data.sender === undefined) {
                    this._errorLog('收到了没有指明发送者的广播', data);
                }
                else if (data.messageName == null) {
                    this._errorLog('收到了消息名称为空的广播', data);
                }
                else if (data.expire === 0 || data.expire > (new Date).getTime()) {
                    const _module = this.receiveList.get(data.sender);
                    const receivers = _module && _module.get(data.messageName);
                    if (receivers !== undefined) {
                        receivers(data.data);
                    }
                    else {
                        this._errorLog('收到了自己没有注册过的广播', data);
                    }
                }
                break;
            default:
                this._errorLog('收到了不存在的消息类型', data);
                break;
        }
    }
    /**
     * 打印错误消息
     *
     * @private
     * @param {string} description 描述
     * @param {*} data 收到的数据
     * @memberof RemoteInvoke
     */
    _errorLog(description, data) {
        if (this.hasListeners('error')) {
            this.emit('error', new Error(`模块：${this.moduleName} ${description}。收到的数据：${JSON.stringify(data)}`));
        }
        else {
            log_formatter_1.default.warn
                .location.white
                .title.yellow
                .content.yellow
                .text.yellow(`remote-invoke: 模块：${this.moduleName}`, description, `收到的数据：`, data);
        }
    }
    /**
     * 对外导出方法
     *
     * @param {string} name 要被导出的方法的名称
     * @param {Function} func 要被导出的方法
     * @returns {Function}
     * @memberof RemoteInvoke
     */
    export(name, func) {
        if (this.exportList.has(name))
            throw new Error(`方法 '${name}' 不可以重复导出。`);
        this.exportList.set(name, func);
        this.emit('export', name);
        return func;
    }
    /**
     * 取消导出方法
     *
     * @param {string} name 导出的方法的名称
     * @returns {void}
     * @memberof RemoteInvoke
     */
    cancelExport(name) {
        if (this.exportList.delete(name))
            this.emit('cancelExport', name);
    }
    /**
     * 注册广播接收器
     *
     * @param {string} sender 发送者的模块名称
     * @param {string} name 广播消息的名称
     * @param {Function} func 对应的回调方法
     * @returns {Function}
     * @memberof RemoteInvoke
     */
    receive(sender, name, func) {
        let _module = this.receiveList.get(sender);
        if (_module === undefined) {
            _module = new Map();
            this.receiveList.set(sender, _module);
        }
        if (_module.has(name))
            throw new Error(`不可以重复注册广播接收器。 '${sender}：${name}'`);
        _module.set(name, func);
        this.emit('receive', name);
        return func;
    }
    /**
     * 删除广播接收器
     *
     * @param {string} sender 发送者的模块名称
     * @param {string} name 广播消息的名称
     * @returns
     * @memberof RemoteInvoke
     */
    cancelReceive(sender, name) {
        const _module = this.receiveList.get(sender);
        if (_module && _module.delete(name))
            this.emit('cancelReceive', name);
    }
    invoke(target, name, ...args) {
        return new Promise((resolve, reject) => {
            const data = args[0];
            const timeout = args[1] === undefined ? this._timeout : args[1] < 0 ? 0 : args[1];
            const invokeFailedRetry = args[2] === undefined ? this._invokeFailedRetry : args[2] < 0 ? 0 : args[2];
            const expire = timeout === 0 ? 0 : (new Date).getTime() + timeout;
            const control = {
                messageID: RemoteInvoke._messageID++,
                targetName: target,
                resolve: (data) => {
                    resolve(data);
                    clearTimeout(timer);
                    this._invokeCallback.delete(control.messageID);
                },
                reject: (err) => {
                    if (invokeFailedRetry > 0)
                        this.invoke(target, name, data, timeout, invokeFailedRetry - 1).then(resolve).catch(reject);
                    else
                        reject(err);
                    clearTimeout(timer);
                    this._invokeCallback.delete(control.messageID);
                }
            };
            const timer = timeout === 0 ? -1 : setTimeout(() => {
                const ctrl = this._invokeCallback.get(control.messageID);
                ctrl && ctrl.reject(new Error('调用超时'));
            }, timeout);
            this._invokeCallback.set(control.messageID, control);
            this._send(target, name, control.messageID, MessageType_1.MessageType.invoke, expire, data).catch(control.reject);
        });
    }
    /**
     * 向外广播消息
     *
     * @param {string} name 消息的名称
     * @param {any} [data] 要发送的数据
     * @param {number} [timeout] 指定消息过期的毫秒数
     *
     * @returns {Promise<any>}
     * @memberof RemoteInvoke
     */
    broadcast(name, data, timeout) {
        timeout = timeout === undefined ? this._timeout : timeout < 0 ? 0 : timeout;
        const expire = timeout === 0 ? 0 : (new Date).getTime() + timeout;
        return this._send(undefined, name, RemoteInvoke._messageID++, MessageType_1.MessageType.broadcast, expire, data);
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
}
RemoteInvoke._messageID = 0; //消息编号从0开始
exports.RemoteInvoke = RemoteInvoke;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbW90ZUludm9rZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFnQztBQUVoQyxzREFBbUQ7QUFFbkQscURBQWtEO0FBSWxEOzs7OztHQUtHO0FBQ0gsa0JBQTBCLFNBQVEsK0JBQWM7SUE2QjVDLFlBQVksTUFBMEI7UUFDbEMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBdEJELG9CQUFlLEdBQWdDLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBRSxTQUFTO1FBU3JGOztXQUVHO1FBQ00sZUFBVSxHQUE0QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRXpFOzs7O1dBSUc7UUFDTSxnQkFBVyxHQUFpRCxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBSTNFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUNwQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEtBQUssU0FBUyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUMzRixJQUFJLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixLQUFLLFNBQVMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDO0lBQ3ZJLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7OztPQWFHO0lBQ0ssS0FBSyxDQUFDLFFBQTRCLEVBQUUsV0FBK0IsRUFBRSxTQUFpQixFQUFFLElBQWlCLEVBQUUsTUFBYyxFQUFFLElBQVMsRUFBRSxLQUFhO1FBRXZKLE1BQU0sV0FBVyxHQUFnQjtZQUM3QixNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDdkIsUUFBUTtZQUNSLFNBQVM7WUFDVCxXQUFXO1lBQ1gsSUFBSTtZQUNKLFFBQVEsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFO1lBQzlCLE1BQU07WUFDTixJQUFJO1lBQ0osS0FBSyxFQUFFLEtBQUssS0FBSyxTQUFTLEdBQUcsU0FBUyxHQUFHLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUMsS0FBSyxHQUFHLFNBQVMsRUFBRTtTQUMvSCxDQUFDO1FBRUYsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNPLFVBQVUsQ0FBQyxJQUFpQjtRQUVsQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNoQixLQUFLLHlCQUFXLENBQUMsTUFBTTtnQkFDbkIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztvQkFDcEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3hDLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDakUsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQXFCLENBQUMsQ0FBQztvQkFDN0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUseUJBQVcsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNqSCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQzt3QkFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7NkJBQ1YsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7NkJBQzFCLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQzs2QkFDaEMsSUFBSSxDQUFDLE1BQU07NEJBQ1IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7Z0NBQ3hELElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO3dCQUN6QyxDQUFDLENBQUMsQ0FBQztvQkFDWCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUN2RSxDQUFDO2dCQUNMLENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1lBRVYsS0FBSyx5QkFBVyxDQUFDLFdBQVc7Z0JBQ3hCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN4QyxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDdEQsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7d0JBQ3JCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7NEJBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsdUNBQXVDLElBQUksQ0FBQyxVQUFVLGtCQUFrQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO3dCQUNsSCxDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNKLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO2dDQUNuQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs0QkFDNUIsSUFBSSxDQUFDLENBQUM7Z0NBQ0YsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztnQ0FDMUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO29DQUN6QixHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO2dDQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUNyQixDQUFDO3dCQUNMLENBQUM7b0JBQ0wsQ0FBQztnQkFDTCxDQUFDO2dCQUNELEtBQUssQ0FBQztZQUVWLEtBQUsseUJBQVcsQ0FBQyxTQUFTO2dCQUN0QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQzVCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUMxQyxDQUFDO2dCQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN6QyxDQUFDO2dCQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2pFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDbEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUUzRCxFQUFFLENBQUMsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQzt3QkFDMUIsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDekIsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDMUMsQ0FBQztnQkFDTCxDQUFDO2dCQUNELEtBQUssQ0FBQztZQUVWO2dCQUNJLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNwQyxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSyxTQUFTLENBQUMsV0FBbUIsRUFBRSxJQUFTO1FBQzVDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksS0FBSyxDQUFDLE1BQU0sSUFBSSxDQUFDLFVBQVUsSUFBSSxXQUFXLFVBQVUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSix1QkFBRyxDQUFDLElBQUk7aUJBQ0gsUUFBUSxDQUFDLEtBQUs7aUJBQ2QsS0FBSyxDQUFDLE1BQU07aUJBQ1osT0FBTyxDQUFDLE1BQU07aUJBQ2QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUYsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsTUFBTSxDQUF1QyxJQUFZLEVBQUUsSUFBTztRQUM5RCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxZQUFZLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsWUFBWSxDQUFDLElBQVk7UUFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsT0FBTyxDQUErQixNQUFjLEVBQUUsSUFBWSxFQUFFLElBQU87UUFDdkUsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0MsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsT0FBTyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLE1BQU0sSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBRXpELE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxhQUFhLENBQUMsTUFBYyxFQUFFLElBQVk7UUFDdEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0MsRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQW1DRCxNQUFNLENBQUMsTUFBYyxFQUFFLElBQVksRUFBRSxHQUFHLElBQVc7UUFDL0MsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU07WUFDL0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEYsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssU0FBUyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEcsTUFBTSxNQUFNLEdBQUcsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQztZQUVsRSxNQUFNLE9BQU8sR0FBbUI7Z0JBQzVCLFNBQVMsRUFBRSxZQUFZLENBQUMsVUFBVSxFQUFFO2dCQUNwQyxVQUFVLEVBQUUsTUFBTTtnQkFDbEIsT0FBTyxFQUFFLENBQUMsSUFBSTtvQkFDVixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2QsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ25ELENBQUM7Z0JBQ0QsTUFBTSxFQUFFLENBQUMsR0FBRztvQkFDUixFQUFFLENBQUMsQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7d0JBQ3RCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ2hHLElBQUk7d0JBQ0EsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUVoQixZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ3BCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDbkQsQ0FBQzthQUNKLENBQUM7WUFFRixNQUFNLEtBQUssR0FBRyxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQztnQkFDMUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzNDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVaLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUseUJBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEcsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0gsU0FBUyxDQUFDLElBQVksRUFBRSxJQUFVLEVBQUUsT0FBZ0I7UUFDaEQsT0FBTyxHQUFHLE9BQU8sS0FBSyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUM7UUFDNUUsTUFBTSxNQUFNLEdBQUcsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUNsRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxVQUFVLEVBQUUsRUFBRSx5QkFBVyxDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkcsQ0FBQztJQWdDRCxFQUFFLENBQUMsS0FBYSxFQUFFLFFBQWtCO1FBQ2hDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQVNELElBQUksQ0FBQyxLQUFhLEVBQUUsUUFBa0I7UUFDbEMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDNUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDOztBQXRXYyx1QkFBVSxHQUFHLENBQUMsQ0FBQyxDQUFFLFVBQVU7QUFGOUMsb0NBeVdDIiwiZmlsZSI6IlJlbW90ZUludm9rZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnbG9nLWZvcm1hdHRlcic7XHJcbmltcG9ydCB7IFNlbmRpbmdEYXRhIH0gZnJvbSAnLi9jb21tb24vU2VuZGluZ0RhdGEnO1xyXG5pbXBvcnQgeyBNZXNzYWdlVHlwZSB9IGZyb20gJy4vY29tbW9uL01lc3NhZ2VUeXBlJztcclxuaW1wb3J0IHsgUmVtb3RlSW52b2tlQ29uZmlnIH0gZnJvbSAnLi9jb21tb24vUmVtb3RlSW52b2tlQ29uZmlnJztcclxuaW1wb3J0IHsgU2VuZGluZ01hbmFnZXIgfSBmcm9tICcuL1NlbmRpbmdNYW5hZ2VyJztcclxuaW1wb3J0IHsgSW52b2tlQ2FsbGJhY2sgfSBmcm9tICcuL2NvbW1vbi9JbnZva2VDYWxsYmFjayc7XHJcbmltcG9ydCB7IENvbm5lY3Rpb25Qb3J0IH0gZnJvbSAnLi9jb21tb24vQ29ubmVjdGlvblBvcnQnO1xyXG5cclxuLyoqXHJcbiAqICDov5znqIvosIPnlKjmjqfliLblmahcclxuICogXHJcbiAqIEBleHBvcnRcclxuICogQGNsYXNzIFJlbW90ZUludm9rZVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFJlbW90ZUludm9rZSBleHRlbmRzIFNlbmRpbmdNYW5hZ2VyIHtcclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfbWVzc2FnZUlEID0gMDsgIC8v5raI5oGv57yW5Y+35LuOMOW8gOWni1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3RpbWVvdXQ6IG51bWJlcjsgLy/or7fmsYLotoXml7ZcclxuXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9yZXBvcnRFcnJvclN0YWNrOiBib29sZWFuO1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2ludm9rZUNhbGxiYWNrOiBNYXA8bnVtYmVyLCBJbnZva2VDYWxsYmFjaz4gPSBuZXcgTWFwKCk7ICAvLyDms6jlhozosIPnlKjlm57osINcclxuXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9pbnZva2VGYWlsZWRSZXRyeTogbnVtYmVyO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qih5Z2X5ZCN56ewXHJcbiAgICAgKi9cclxuICAgIHJlYWRvbmx5IG1vZHVsZU5hbWU6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWvueWkluWvvOWHuueahOaWueazleWIl+ihqFxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBleHBvcnRMaXN0OiBNYXA8c3RyaW5nLCAoYXJnOiBhbnkpID0+IFByb21pc2U8YW55Pj4gPSBuZXcgTWFwKCk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDms6jlhoznmoTlub/mkq3mjqXmlLblmaggICAgXHJcbiAgICAgKiBcclxuICAgICAqIGtlee+8mm1vZHVsZU5hbWUgLT4gbWVzc2FnZU5hbWVcclxuICAgICAqL1xyXG4gICAgcmVhZG9ubHkgcmVjZWl2ZUxpc3Q6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIChhcmc6IGFueSkgPT4gdm9pZD4+ID0gbmV3IE1hcCgpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogUmVtb3RlSW52b2tlQ29uZmlnKSB7XHJcbiAgICAgICAgc3VwZXIoY29uZmlnKTtcclxuICAgICAgICB0aGlzLm1vZHVsZU5hbWUgPSBjb25maWcubW9kdWxlTmFtZTtcclxuICAgICAgICB0aGlzLl9yZXBvcnRFcnJvclN0YWNrID0gISFjb25maWcucmVwb3J0RXJyb3JTdGFjaztcclxuICAgICAgICB0aGlzLl90aW1lb3V0ID0gY29uZmlnLnRpbWVvdXQgPT09IHVuZGVmaW5lZCA/IDAgOiBjb25maWcudGltZW91dCA8IDAgPyAwIDogY29uZmlnLnRpbWVvdXQ7XHJcbiAgICAgICAgdGhpcy5faW52b2tlRmFpbGVkUmV0cnkgPSBjb25maWcuaW52b2tlRmFpbGVkUmV0cnkgPT09IHVuZGVmaW5lZCA/IDAgOiBjb25maWcuaW52b2tlRmFpbGVkUmV0cnkgPCAwID8gMCA6IGNvbmZpZy5pbnZva2VGYWlsZWRSZXRyeTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPkemAgea2iOaBr1xyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHsoc3RyaW5nIHwgdW5kZWZpbmVkKX0gcmVjZWl2ZXIg5o6l5pS25qih5Z2X55qE5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZU5hbWUg5raI5oGv55qE5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZUlEIOa2iOaBr+eahOe8luWPt1xyXG4gICAgICogQHBhcmFtIHtNZXNzYWdlVHlwZX0gdHlwZSDmtojmga/nmoTnsbvlnotcclxuICAgICAqIEBwYXJhbSB7KG51bWJlciB8IHVuZGVmaW5lZCl9IGV4cGlyZSDov4fmnJ/ml7bpl7RcclxuICAgICAqIEBwYXJhbSB7YW55fSBkYXRhIOimgeWPkemAgeeahOaVsOaNrlxyXG4gICAgICogQHBhcmFtIHtFcnJvcn0gW2Vycm9yXSDopoHlj43ppojnu5nosIPnlKjliJnnmoTplJnor6/kv6Hmga9cclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fSBcclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfc2VuZChyZWNlaXZlcjogc3RyaW5nIHwgdW5kZWZpbmVkLCBtZXNzYWdlTmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkLCBtZXNzYWdlSUQ6IG51bWJlciwgdHlwZTogTWVzc2FnZVR5cGUsIGV4cGlyZTogbnVtYmVyLCBkYXRhOiBhbnksIGVycm9yPzogRXJyb3IpOiBQcm9taXNlPHZvaWQ+IHtcclxuXHJcbiAgICAgICAgY29uc3Qgc2VuZGluZ0RhdGE6IFNlbmRpbmdEYXRhID0ge1xyXG4gICAgICAgICAgICBzZW5kZXI6IHRoaXMubW9kdWxlTmFtZSxcclxuICAgICAgICAgICAgcmVjZWl2ZXIsXHJcbiAgICAgICAgICAgIG1lc3NhZ2VJRCxcclxuICAgICAgICAgICAgbWVzc2FnZU5hbWUsXHJcbiAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgIHNlbmRUaW1lOiAobmV3IERhdGUpLmdldFRpbWUoKSxcclxuICAgICAgICAgICAgZXhwaXJlLFxyXG4gICAgICAgICAgICBkYXRhLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHsgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwgc3RhY2s6IHRoaXMuX3JlcG9ydEVycm9yU3RhY2sgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLl9zZW5kRGF0YShzZW5kaW5nRGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmjqXmlLbmtojmga9cclxuICAgICAqIFxyXG4gICAgICogQHByb3RlY3RlZFxyXG4gICAgICogQHBhcmFtIHtTZW5kaW5nRGF0YX0gZGF0YSDmlLbliLDnmoTmlbDmja5cclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIF9vbk1lc3NhZ2UoZGF0YTogU2VuZGluZ0RhdGEpIHtcclxuXHJcbiAgICAgICAgc3dpdGNoIChkYXRhLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBNZXNzYWdlVHlwZS5pbnZva2U6XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZWNlaXZlciAhPT0gdGhpcy5tb2R1bGVOYW1lKSB7ICAgLy/noa7kv53mlLbku7bkurpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvckxvZygn5pS25Yiw5LqG5LiN5bGe5LqO6Ieq5bex55qE5raI5oGvJywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuZXhwaXJlID09PSAwIHx8IGRhdGEuZXhwaXJlID4gKG5ldyBEYXRlKS5nZXRUaW1lKCkpIHsgICAvL+ehruS/nea2iOaBr+i/mOayoeaciei/h+acn1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ1bmMgPSB0aGlzLmV4cG9ydExpc3QuZ2V0KGRhdGEubWVzc2FnZU5hbWUgYXMgc3RyaW5nKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZW5kID0gdGhpcy5fc2VuZC5iaW5kKHRoaXMsIGRhdGEuc2VuZGVyLCB1bmRlZmluZWQsIGRhdGEubWVzc2FnZUlELCBNZXNzYWdlVHlwZS5yZXBseUludm9rZSwgZGF0YS5leHBpcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmdW5jICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyhkYXRhLmRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0KSA9PiBbcmVzdWx0XSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiBbdW5kZWZpbmVkLCBlcnJdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHsgICAvL+ehruS/neaJp+ihjOWujOS6huS5n+WcqOi/h+acn+aXtumXtOS5i+WGhVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmV4cGlyZSA9PT0gMCB8fCBkYXRhLmV4cGlyZSA+IChuZXcgRGF0ZSkuZ2V0VGltZSgpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kKC4uLnJlc3VsdCkuY2F0Y2goKCkgPT4geyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmQodW5kZWZpbmVkLCBuZXcgRXJyb3IoJ+iwg+eUqOi/nOerr+aooeWdl+eahOaWueazleS4jeWtmOWcqOaIluiAheayoeacieiiq+WvvOWHuicpKS5jYXRjaCgoKSA9PiB7IH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBNZXNzYWdlVHlwZS5yZXBseUludm9rZTpcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlY2VpdmVyICE9PSB0aGlzLm1vZHVsZU5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvckxvZygn5pS25Yiw5LqG5LiN5bGe5LqO6Ieq5bex55qE5raI5oGvJywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN0cmwgPSB0aGlzLl9pbnZva2VDYWxsYmFjay5nZXQoZGF0YS5tZXNzYWdlSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHJsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN0cmwudGFyZ2V0TmFtZSAhPT0gZGF0YS5zZW5kZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwucmVqZWN0KG5ldyBFcnJvcihg6L+c56uv6LCD55So6L+U5Zue55qE57uT5p6c5bm25LiN5piv55Sx5pyf5pyb55qE6KKr6LCD55So6ICF6L+U5Zue55qE77yBXFxyXFxu5pyf5pyb55qE6KKr6LCD55So6ICF77yaJHtjdHJsLnRhcmdldE5hbWV9ICAg5a6e6ZmF6L+U5Zue57uT5p6c55qE6KKr6LCD55So6ICF77yaJHtkYXRhLnNlbmRlcn1gKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5lcnJvciA9PSBudWxsKSAgIC8v5qOA5p+l6L+c56uv5omn6KGM5piv5ZCm5Ye66ZSZXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC5yZXNvbHZlKGRhdGEuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoZGF0YS5lcnJvci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5lcnJvci5zdGFjayAhPSBudWxsKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIuc3RhY2sgPSBkYXRhLmVycm9yLnN0YWNrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgTWVzc2FnZVR5cGUuYnJvYWRjYXN0OlxyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuc2VuZGVyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvckxvZygn5pS25Yiw5LqG5rKh5pyJ5oyH5piO5Y+R6YCB6ICF55qE5bm/5pKtJywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEubWVzc2FnZU5hbWUgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Vycm9yTG9nKCfmlLbliLDkuobmtojmga/lkI3np7DkuLrnqbrnmoTlub/mkq0nLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5leHBpcmUgPT09IDAgfHwgZGF0YS5leHBpcmUgPiAobmV3IERhdGUpLmdldFRpbWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9tb2R1bGUgPSB0aGlzLnJlY2VpdmVMaXN0LmdldChkYXRhLnNlbmRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZWl2ZXJzID0gX21vZHVsZSAmJiBfbW9kdWxlLmdldChkYXRhLm1lc3NhZ2VOYW1lKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY2VpdmVycyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpdmVycyhkYXRhLmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Vycm9yTG9nKCfmlLbliLDkuoboh6rlt7HmsqHmnInms6jlhozov4fnmoTlub/mkq0nLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9lcnJvckxvZygn5pS25Yiw5LqG5LiN5a2Y5Zyo55qE5raI5oGv57G75Z6LJywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiZPljbDplJnor6/mtojmga9cclxuICAgICAqIFxyXG4gICAgICogQHByaXZhdGVcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkZXNjcmlwdGlvbiDmj4/ov7BcclxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSDmlLbliLDnmoTmlbDmja5cclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfZXJyb3JMb2coZGVzY3JpcHRpb246IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaGFzTGlzdGVuZXJzKCdlcnJvcicpKSB7ICAgLy/lpoLmnpzms6jlhozkuobplJnor6/nm5HlkKzlmajlsLHkuI3miZPljbDkuoZcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihg5qih5Z2X77yaJHt0aGlzLm1vZHVsZU5hbWV9ICR7ZGVzY3JpcHRpb25944CC5pS25Yiw55qE5pWw5o2u77yaJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbG9nLndhcm5cclxuICAgICAgICAgICAgICAgIC5sb2NhdGlvbi53aGl0ZVxyXG4gICAgICAgICAgICAgICAgLnRpdGxlLnllbGxvd1xyXG4gICAgICAgICAgICAgICAgLmNvbnRlbnQueWVsbG93XHJcbiAgICAgICAgICAgICAgICAudGV4dC55ZWxsb3coYHJlbW90ZS1pbnZva2U6IOaooeWdl++8miR7dGhpcy5tb2R1bGVOYW1lfWAsIGRlc2NyaXB0aW9uLCBg5pS25Yiw55qE5pWw5o2u77yaYCwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5a+55aSW5a+85Ye65pa55rOVXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIOimgeiiq+WvvOWHuueahOaWueazleeahOWQjeensFxyXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyDopoHooqvlr7zlh7rnmoTmlrnms5VcclxuICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gXHJcbiAgICAgKiBAbWVtYmVyb2YgUmVtb3RlSW52b2tlXHJcbiAgICAgKi9cclxuICAgIGV4cG9ydDxGIGV4dGVuZHMgKGFyZzogYW55KSA9PiBQcm9taXNlPGFueT4+KG5hbWU6IHN0cmluZywgZnVuYzogRik6IEYge1xyXG4gICAgICAgIGlmICh0aGlzLmV4cG9ydExpc3QuaGFzKG5hbWUpKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaWueazlSAnJHtuYW1lfScg5LiN5Y+v5Lul6YeN5aSN5a+85Ye644CCYCk7XHJcblxyXG4gICAgICAgIHRoaXMuZXhwb3J0TGlzdC5zZXQobmFtZSwgZnVuYyk7XHJcbiAgICAgICAgdGhpcy5lbWl0KCdleHBvcnQnLCBuYW1lKTtcclxuICAgICAgICByZXR1cm4gZnVuYztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPlua2iOWvvOWHuuaWueazlVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSDlr7zlh7rnmoTmlrnms5XnmoTlkI3np7BcclxuICAgICAqIEByZXR1cm5zIHt2b2lkfSBcclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgY2FuY2VsRXhwb3J0KG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGlmICh0aGlzLmV4cG9ydExpc3QuZGVsZXRlKG5hbWUpKVxyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2NhbmNlbEV4cG9ydCcsIG5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5rOo5YaM5bm/5pKt5o6l5pS25ZmoXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZW5kZXIg5Y+R6YCB6ICF55qE5qih5Z2X5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSDlub/mkq3mtojmga/nmoTlkI3np7BcclxuICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMg5a+55bqU55qE5Zue6LCD5pa55rOVXHJcbiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFxyXG4gICAgICogQG1lbWJlcm9mIFJlbW90ZUludm9rZVxyXG4gICAgICovXHJcbiAgICByZWNlaXZlPEYgZXh0ZW5kcyAoYXJnOiBhbnkpID0+IHZvaWQ+KHNlbmRlcjogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGZ1bmM6IEYpOiBGIHtcclxuICAgICAgICBsZXQgX21vZHVsZSA9IHRoaXMucmVjZWl2ZUxpc3QuZ2V0KHNlbmRlcik7XHJcbiAgICAgICAgaWYgKF9tb2R1bGUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBfbW9kdWxlID0gbmV3IE1hcCgpO1xyXG4gICAgICAgICAgICB0aGlzLnJlY2VpdmVMaXN0LnNldChzZW5kZXIsIF9tb2R1bGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKF9tb2R1bGUuaGFzKG5hbWUpKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOS4jeWPr+S7pemHjeWkjeazqOWGjOW5v+aSreaOpeaUtuWZqOOAgiAnJHtzZW5kZXJ977yaJHtuYW1lfSdgKTtcclxuXHJcbiAgICAgICAgX21vZHVsZS5zZXQobmFtZSwgZnVuYyk7XHJcbiAgICAgICAgdGhpcy5lbWl0KCdyZWNlaXZlJywgbmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKDpmaTlub/mkq3mjqXmlLblmahcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNlbmRlciDlj5HpgIHogIXnmoTmqKHlnZflkI3np7BcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIOW5v+aSrea2iOaBr+eahOWQjeensFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKiBAbWVtYmVyb2YgUmVtb3RlSW52b2tlXHJcbiAgICAgKi9cclxuICAgIGNhbmNlbFJlY2VpdmUoc2VuZGVyOiBzdHJpbmcsIG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IF9tb2R1bGUgPSB0aGlzLnJlY2VpdmVMaXN0LmdldChzZW5kZXIpO1xyXG4gICAgICAgIGlmIChfbW9kdWxlICYmIF9tb2R1bGUuZGVsZXRlKG5hbWUpKVxyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2NhbmNlbFJlY2VpdmUnLCBuYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiwg+eUqOi/nOerr+aooeWdl+eahOaWueazlVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0IOi/nOerr+aooeWdl+eahOWQjeensFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUg6KaB6LCD55So55qE5pa55rOV5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0ge2FueX0gW2RhdGFdIOimgeS8oOmAkueahOaVsOaNrlxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8YW55Pn0gXHJcbiAgICAgKiBAbWVtYmVyb2YgUmVtb3RlSW52b2tlXHJcbiAgICAgKi9cclxuICAgIGludm9rZSh0YXJnZXQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBkYXRhPzogYW55KTogUHJvbWlzZTxhbnk+XHJcbiAgICAvKipcclxuICAgICAqIOiwg+eUqOi/nOerr+aooeWdl+eahOaWueazlVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0IOi/nOerr+aooeWdl+eahOWQjeensFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUg6KaB6LCD55So55qE5pa55rOV5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0ge2FueX0gW2RhdGFdIOimgeS8oOmAkueahOaVsOaNrlxyXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0XSDopobnm5bpu5jorqTnmoTosIPnlKjotoXml7bnmoTmr6vnp5LmlbBcclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59IFxyXG4gICAgICogQG1lbWJlcm9mIFJlbW90ZUludm9rZVxyXG4gICAgICovXHJcbiAgICBpbnZva2UodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZGF0YT86IGFueSwgdGltZW91dD86IG51bWJlcik6IFByb21pc2U8YW55PlxyXG4gICAgLyoqXHJcbiAgICAgKiDosIPnlKjov5znq6/mqKHlnZfnmoTmlrnms5VcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRhcmdldCDov5znq6/mqKHlnZfnmoTlkI3np7BcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIOimgeiwg+eUqOeahOaWueazleWQjeensFxyXG4gICAgICogQHBhcmFtIHthbnl9IFtkYXRhXSDopoHkvKDpgJLnmoTmlbDmja5cclxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dF0g6KaG55uW6buY6K6k55qE6LCD55So6LaF5pe255qE5q+r56eS5pWwXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2ludm9rZUZhaWxlZFJldHJ5XSDosIPnlKjlpLHotKXoh6rliqjph43or5XmrKHmlbDvvIjpu5jorqQw77yM5LiN6YeN6K+V77yJXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fSBcclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgaW52b2tlKHRhcmdldDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGRhdGE/OiBhbnksIHRpbWVvdXQ/OiBudW1iZXIsIGludm9rZUZhaWxlZFJldHJ5PzogbnVtYmVyKTogUHJvbWlzZTxhbnk+XHJcbiAgICBpbnZva2UodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgLi4uYXJnczogYW55W10pOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhcmdzWzBdO1xyXG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gYXJnc1sxXSA9PT0gdW5kZWZpbmVkID8gdGhpcy5fdGltZW91dCA6IGFyZ3NbMV0gPCAwID8gMCA6IGFyZ3NbMV07XHJcbiAgICAgICAgICAgIGNvbnN0IGludm9rZUZhaWxlZFJldHJ5ID0gYXJnc1syXSA9PT0gdW5kZWZpbmVkID8gdGhpcy5faW52b2tlRmFpbGVkUmV0cnkgOiBhcmdzWzJdIDwgMCA/IDAgOiBhcmdzWzJdO1xyXG4gICAgICAgICAgICBjb25zdCBleHBpcmUgPSB0aW1lb3V0ID09PSAwID8gMCA6IChuZXcgRGF0ZSkuZ2V0VGltZSgpICsgdGltZW91dDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2w6IEludm9rZUNhbGxiYWNrID0ge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZUlEOiBSZW1vdGVJbnZva2UuX21lc3NhZ2VJRCsrLFxyXG4gICAgICAgICAgICAgICAgdGFyZ2V0TmFtZTogdGFyZ2V0LFxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZTogKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW52b2tlQ2FsbGJhY2suZGVsZXRlKGNvbnRyb2wubWVzc2FnZUlEKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZWplY3Q6IChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW52b2tlRmFpbGVkUmV0cnkgPiAwKSAgLy/lpoLmnpzov5jpnIDopoHph43or5VcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZva2UodGFyZ2V0LCBuYW1lLCBkYXRhLCB0aW1lb3V0LCBpbnZva2VGYWlsZWRSZXRyeSAtIDEpLnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2ludm9rZUNhbGxiYWNrLmRlbGV0ZShjb250cm9sLm1lc3NhZ2VJRCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0aW1lciA9IHRpbWVvdXQgPT09IDAgPyAtMSA6IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY3RybCA9IHRoaXMuX2ludm9rZUNhbGxiYWNrLmdldChjb250cm9sLm1lc3NhZ2VJRCk7XHJcbiAgICAgICAgICAgICAgICBjdHJsICYmIGN0cmwucmVqZWN0KG5ldyBFcnJvcign6LCD55So6LaF5pe2JykpO1xyXG4gICAgICAgICAgICB9LCB0aW1lb3V0KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2ludm9rZUNhbGxiYWNrLnNldChjb250cm9sLm1lc3NhZ2VJRCwgY29udHJvbCk7XHJcbiAgICAgICAgICAgIHRoaXMuX3NlbmQodGFyZ2V0LCBuYW1lLCBjb250cm9sLm1lc3NhZ2VJRCwgTWVzc2FnZVR5cGUuaW52b2tlLCBleHBpcmUsIGRhdGEpLmNhdGNoKGNvbnRyb2wucmVqZWN0KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWQkeWkluW5v+aSrea2iOaBr1xyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSDmtojmga/nmoTlkI3np7BcclxuICAgICAqIEBwYXJhbSB7YW55fSBbZGF0YV0g6KaB5Y+R6YCB55qE5pWw5o2uXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXRdIOaMh+Wumua2iOaBr+i/h+acn+eahOavq+enkuaVsFxyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fSBcclxuICAgICAqIEBtZW1iZXJvZiBSZW1vdGVJbnZva2VcclxuICAgICAqL1xyXG4gICAgYnJvYWRjYXN0KG5hbWU6IHN0cmluZywgZGF0YT86IGFueSwgdGltZW91dD86IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHRpbWVvdXQgPSB0aW1lb3V0ID09PSB1bmRlZmluZWQgPyB0aGlzLl90aW1lb3V0IDogdGltZW91dCA8IDAgPyAwIDogdGltZW91dDtcclxuICAgICAgICBjb25zdCBleHBpcmUgPSB0aW1lb3V0ID09PSAwID8gMCA6IChuZXcgRGF0ZSkuZ2V0VGltZSgpICsgdGltZW91dDtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZCh1bmRlZmluZWQsIG5hbWUsIFJlbW90ZUludm9rZS5fbWVzc2FnZUlEKyssIE1lc3NhZ2VUeXBlLmJyb2FkY2FzdCwgZXhwaXJlLCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlrprkuYnkuovku7ZcclxuXHJcbiAgICAvKipcclxuICAgICAqIOazqOWGjOmUmeivr+ebkeWQrOWZqOOAguWmguaenOayoeacieazqOWGjOmUmeivr+ebkeWQrOWZqO+8jOWImeiHquWKqOS8muWwhuaJgOaciemUmeivr+a2iOaBr+aJk+WNsOWHuuadpVxyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ2Vycm9yJywgbGlzdGVuZXI6IChlcnI6IEVycm9yKSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPmnInmlrDnmoTmlrnms5Xooqvlr7zlh7rml7bop6blj5FcclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICdleHBvcnQnLCBsaXN0ZW5lcjogKG5hbWU6IHN0cmluZykgPT4gYW55KTogdGhpcztcclxuICAgIC8qKlxyXG4gICAgICog5b2T5pyJ5pa55rOV6KKr5Y+W5raI5a+85Ye65pe26Kem5Y+RXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnY2FuY2VsRXhwb3J0JywgbGlzdGVuZXI6IChuYW1lOiBzdHJpbmcpID0+IGFueSk6IHRoaXM7XHJcbiAgICAvKipcclxuICAgICAqIOW9k+acieaWsOeahOW5v+aSreaOpeaUtuWZqOiiq+azqOWGjOaXtuinpuWPkVxyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ3JlY2VpdmUnLCBsaXN0ZW5lcjogKG5hbWU6IHN0cmluZykgPT4gYW55KTogdGhpcztcclxuICAgIC8qKlxyXG4gICAgICog5b2T5pyJ5bm/5pKt5o6l5pS25Zmo6KKr5Yig6Zmk5pe26Kem5Y+RXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnY2FuY2VsUmVjZWl2ZScsIGxpc3RlbmVyOiAobmFtZTogc3RyaW5nKSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgLyoqXHJcbiAgICAgKiDms6jlhozmt7vliqDmlrDnmoTov57mjqXnq6/lj6Pnm5HlkKzlmahcclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICdhZGRDb25uZWN0aW9uUG9ydCcsIGxpc3RlbmVyOiAoY29ubmVjdGlvbjogQ29ubmVjdGlvblBvcnQpID0+IGFueSk6IHRoaXM7XHJcbiAgICAvKipcclxuICAgICAqIOazqOWGjOWIoOmZpOi/nuaOpeerr+WPo+ebkeWQrOWZqFxyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ3JlbW92ZUNvbm5lY3Rpb25Qb3J0JywgbGlzdGVuZXI6IChjb25uZWN0aW9uOiBDb25uZWN0aW9uUG9ydCkgPT4gYW55KTogdGhpcztcclxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiBGdW5jdGlvbik6IHRoaXMge1xyXG4gICAgICAgIHN1cGVyLm9uKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgb25jZShldmVudDogJ2Vycm9yJywgbGlzdGVuZXI6IChlcnI6IEVycm9yKSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogJ2V4cG9ydCcsIGxpc3RlbmVyOiAobmFtZTogc3RyaW5nKSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogJ2NhbmNlbEV4cG9ydCcsIGxpc3RlbmVyOiAobmFtZTogc3RyaW5nKSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogJ3JlY2VpdmUnLCBsaXN0ZW5lcjogKG5hbWU6IHN0cmluZykgPT4gYW55KTogdGhpcztcclxuICAgIG9uY2UoZXZlbnQ6ICdjYW5jZWxSZWNlaXZlJywgbGlzdGVuZXI6IChuYW1lOiBzdHJpbmcpID0+IGFueSk6IHRoaXM7XHJcbiAgICBvbmNlKGV2ZW50OiAnYWRkQ29ubmVjdGlvblBvcnQnLCBsaXN0ZW5lcjogKGNvbm5lY3Rpb246IENvbm5lY3Rpb25Qb3J0KSA9PiBhbnkpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogJ3JlbW92ZUNvbm5lY3Rpb25Qb3J0JywgbGlzdGVuZXI6IChjb25uZWN0aW9uOiBDb25uZWN0aW9uUG9ydCkgPT4gYW55KTogdGhpcztcclxuICAgIG9uY2UoZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6IEZ1bmN0aW9uKTogdGhpcyB7XHJcbiAgICAgICAgc3VwZXIub25jZShldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG59Il19
